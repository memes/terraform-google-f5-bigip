# yamllint disable-line rule:line-length
# spell-checker: ignore yamllint bigip payg tfvars nics inspec preemptible extramb gcloud
---
# yamllint disable
<%
# Fall back to current time and known location for report files if not present
# in ENV
report_dir = ENV['REPORT_DIR'] || 'test/reports'
report_ts = ENV['REPORT_TS'] || DateTime.now.rfc3339

# Constants for BIG-IP version testing; these values will be used to fill in
# template providers/suites for each BIG-IP version to be tested.
test_params = [
  {
    :image => 'projects/f5-7626-networks-public/global/images/f5-bigip-16-0-1-1-0-0-6-payg-good-25mbps-210129040032',
    :region => 'us-west1',
    :version => '16',
  },
  {
    :image => 'projects/f5-7626-networks-public/global/images/f5-bigip-15-1-2-1-0-0-10-payg-good-25mbps-210115160742',
    :region => 'us-central1',
    :version => '15',
  },
  {
    :image => 'projects/f5-7626-networks-public/global/images/f5-bigip-14-1-4-0-0-11-payg-good-25mbps-210211220757',
    :region => 'us-east1',
    :version => '14',
  },
  # TODO: @memes - do not include BIG-IP v13 in tests - jq failure (see #115)
  # {
  #   :image => 'projects/f5-7626-networks-public/global/images/f5-bigip-13-1-3-6-0-0-4-payg-good-25mbps-210129042237',
  #   :region => 'us-west2',
  #   :version => '13',
  # },
]
%>
# yamllint enable
driver:
  name: terraform
  command_timeout: 300
  # Kitchen-terraform does not support Terraform 0.15 yet - throw an error if used
  # See https://github.com/newcontext-oss/kitchen-terraform/issues/445
  verify_version: true
  variables:
    # These are the defaults used by all platforms unless overridden
    reserve_addresses: "false"
    num_instances: "2"
    enable_serial_console: "true"
    metadata: '{details_on_error=\"true\"}'
  variable_files:
    # Load in the values generated by foundational setup
    - test/setup/harness.tfvars

provisioner:
  name: terraform

verifier:
  name: terraform
  color: true

platforms:
<%
test_params.each do |params|
  (1..8).each do |nics| %>
  - name: <%= params[:version] %>-root-<%= nics %>nic-minimal
    driver:
      root_module_directory: test/fixtures/root
      variables:
        image: "<%= params[:image] %>"
        bigip_version: "<%= params[:version] %>"
        region: "<%= params[:region] %>"
        num_nics: "<%= nics %>"
        instance_name_template: "r<%= nics %>m%d"
        machine_type: "<%= nics > 4 ? 'n1-standard-8' : 'n1-standard-4' %>"
    verifier:
      systems:
        - name: inspec-gcp
          backend: gcp
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-root-<%= nics %>nic-minimal-gcp-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-root-<%= nics %>nic-minimal-gcp-<%= report_ts %>.html
        - name: local
          backend: local
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-root-<%= nics %>nic-minimal-local-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-root-<%= nics %>nic-minimal-local-<%= report_ts %>.html
  <% end %>
  - name: <%= params[:version] %>-root-8nic-full
    driver:
      root_module_directory: test/fixtures/root
      variables:
        image: "<%= params[:image] %>"
        bigip_version: "<%= params[:version] %>"
        region: "<%= params[:region] %>"
        num_nics: "8"
        reserve_addresses: "true"
        instance_name_template: "r8f%d"
        machine_type: n1-standard-8
        instance_ordinal_offset: "1"
        domain_name: example.com
        # kitchen-terraform always applies -var then -var-file, so admin
        # password key output from test/setup workspace cannot be overridden
        # here. An extra input variable has been added to test/fixture/root to
        # allow overriding from -var.
        override_admin_password_secret_manager_key: admin-password
        secret_implementor: metadata
        # spellchecker: disable
        # yamllint disable-line rule:line-length
        metadata: '{env=\"test\", owner=\"jane\", ssh-keys=\"foo bar baz\", admin-password=\"Foob@r1234\", details_on_error=\"true\"}'
        # spellchecker: enable
        labels: '{alpha=\"one\", beta=\"two\"}'
        tags: '[\"apple\",\"banana\"]'
        min_cpu_platform: Intel Skylake
        automatic_restart: "false"
        preemptible: "true"
        ssh_keys: "admin: ssh-rsa THIS IS NOT A VALID SSH KEY: admin"
        delete_disk_on_destroy: "true"
        disk_type: pd-standard
        disk_size_gb: "50"
        provision_external_public_ip: "false"
        external_subnetwork_tier: STANDARD
        provision_management_public_ip: "true"
        management_subnetwork_tier: STANDARD
        provision_internal_public_ip: "true"
        internal_subnetwork_tier: STANDARD
        allow_phone_home: "false"
        default_gateway: "172.16.0.1"
        use_cloud_init: "true"
        custom_script: "exit 0"
        ntp_servers: '[\"169.254.169.254\", \"132.163.96.1\", \"132.163.96.2\"]'
        timezone: America/Los_Angeles
        modules: '{ltm=\"nominal\", asm=\"none\"}'
        dns_servers: '[\"169.254.169.254\", \"9.9.9.9\"]'
        search_domains: '[\"example.com\"]'
        # yamllint disable-line rule:line-length
        install_cloud_libs: '[\"https://github.com/F5Networks/f5-appsvcs-extension/releases/download/v3.25.0/f5-appsvcs-3.25.0-3.noarch.rpm\",\"https://github.com/F5Networks/f5-declarative-onboarding/releases/download/v1.18.0/f5-declarative-onboarding-1.18.0-4.noarch.rpm\"]'
        extramb: "2560"
        as3_payloads: '[]'
        do_payloads: '[]'
    verifier:
      systems:
        - name: inspec-gcp
          backend: gcp
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-root-8nic-full-gcp-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-root-8nic-full-gcp-<%= report_ts %>.html
        - name: local
          backend: local
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-root-8nic-full-local-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-root-8nic-full-local-<%= report_ts %>.html
  <% (2..8).each do |nics| %>
  - name: <%= params[:version] %>-ha-<%= nics %>nic-minimal
    driver:
      root_module_directory: test/fixtures/ha
      variables:
        image: "<%= params[:image] %>"
        bigip_version: "<%= params[:version] %>"
        region: "<%= params[:region] %>"
        num_nics: "<%= nics %>"
        reserve_addresses: "true"
        instance_name_template: "h<%= nics %>m%d"
        machine_type: "<%= nics > 4 ? 'n1-standard-8' : 'n1-standard-4' %>"
    verifier:
      systems:
        - name: inspec-gcp
          backend: gcp
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-ha-<%= nics %>nic-minimal-gcp-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-ha-<%= nics %>nic-minimal-gcp-<%= report_ts %>.html
        - name: local
          backend: local
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-ha-<%= nics %>nic-minimal-local-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-ha-<%= nics %>nic-minimal-local-<%= report_ts %>.html
  <% end %>
  - name: <%= params[:version] %>-ha-8nic-full
    driver:
      root_module_directory: test/fixtures/ha
      variables:
        image: "<%= params[:image] %>"
        bigip_version: "<%= params[:version] %>"
        region: "<%= params[:region] %>"
        num_nics: "8"
        reserve_addresses: "true"

        instance_name_template: "h8f%d"
        machine_type: n1-standard-8
        instance_ordinal_offset: "1"
        domain_name: example.com
        # kitchen-terraform always applies -var then -var-file, so admin
        # password key output from test/setup workspace cannot be overridden
        # here. An extra input variable has been added to test/fixture/ha to
        # allow overriding from -var.
        override_admin_password_secret_manager_key: admin-password
        secret_implementor: metadata
        # spellchecker: disable
        # yamllint disable-line rule:line-length
        metadata: '{env=\"test\", owner=\"jane\", ssh-keys=\"foo bar baz\", admin-password=\"Foob@r1234\", details_on_error=\"true\"}'
        # spellchecker: enable
        labels: '{alpha=\"one\", beta=\"two\"}'
        tags: '[\"apple\",\"banana\"]'
        min_cpu_platform: Intel Skylake
        automatic_restart: "false"
        preemptible: "true"
        ssh_keys: "admin: ssh-rsa THIS IS NOT A VALID SSH KEY: admin"
        delete_disk_on_destroy: "true"
        disk_type: pd-standard
        disk_size_gb: "50"
        provision_external_public_ip: "false"
        external_subnetwork_tier: STANDARD
        provision_management_public_ip: "true"
        management_subnetwork_tier: STANDARD
        provision_internal_public_ip: "true"
        internal_subnetwork_tier: STANDARD
        allow_phone_home: "false"
        default_gateway: "172.16.0.1"
        use_cloud_init: "true"
        custom_script: "exit 0"
        ntp_servers: '[\"169.254.169.254\", \"132.163.96.1\", \"132.163.96.2\"]'
        timezone: America/Los_Angeles
        modules: '{ltm=\"nominal\", asm=\"none\"}'
        dns_servers: '[\"169.254.169.254\", \"9.9.9.9\"]'
        search_domains: '[\"example.com\"]'
        # yamllint disable-line rule:line-length
        install_cloud_libs: '[\"https://github.com/F5Networks/f5-appsvcs-extension/releases/download/v3.25.0/f5-appsvcs-3.25.0-3.noarch.rpm\",\"https://github.com/F5Networks/f5-declarative-onboarding/releases/download/v1.18.0/f5-declarative-onboarding-1.18.0-4.noarch.rpm\"]'
        extramb: "2560"
        as3_payloads: '[]'
        do_payloads: '[]'
    verifier:
      systems:
        - name: inspec-gcp
          backend: gcp
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-ha-8nic-full-gcp-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-ha-8nic-full-gcp-<%= report_ts %>.html
        - name: local
          backend: local
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-ha-8nic-full-local-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-ha-8nic-full-local-<%= report_ts %>.html
  <% (2..8).each do |nics| %>
  - name: <%= params[:version] %>-cfe-<%= nics %>nic-minimal
    driver:
      root_module_directory: test/fixtures/cfe
      variables:
        image: "<%= params[:image] %>"
        bigip_version: "<%= params[:version] %>"
        region: "<%= params[:region] %>"
        num_nics: "<%= nics %>"
        reserve_addresses: "true"
        instance_name_template: "c<%= nics %>m%d"
        machine_type: "<%= nics > 4 ? 'n1-standard-8' : 'n1-standard-4' %>"
        cfe_label_value: "cfe-<%= nics %>nic-minimal"
    verifier:
      systems:
        - name: inspec-gcp
          backend: gcp
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-cfe-<%= nics %>nic-minimal-gcp-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-cfe-<%= nics %>nic-minimal-gcp-<%= report_ts %>.html
        - name: local
          backend: local
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-cfe-<%= nics %>nic-minimal-local-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-cfe-<%= nics %>nic-minimal-local-<%= report_ts %>.html
  <% end %>
  - name: <%= params[:version] %>-cfe-8nic-full
    driver:
      root_module_directory: test/fixtures/cfe
      variables:
        image: "<%= params[:image] %>"
        bigip_version: "<%= params[:version] %>"
        region: "<%= params[:region] %>"
        num_nics: "8"
        reserve_addresses: "true"
        instance_name_template: "c8f%d"
        machine_type: n1-standard-8
        cfe_label_key: "cfe-8nic-fixture"
        cfe_label_value: "cfe-8nic-full"
        instance_ordinal_offset: "1"
        domain_name: example.com
        # kitchen-terraform always applies -var then -var-file, so admin
        # password key output from test/setup workspace cannot be overridden
        # here. An extra input variable has been added to test/fixture/cfe to
        # allow overriding from -var.
        override_admin_password_secret_manager_key: admin-password
        secret_implementor: metadata
        # spellchecker: disable
        # yamllint disable-line rule:line-length
        metadata: '{env=\"test\", owner=\"jane\", ssh-keys=\"foo bar baz\", admin-password=\"Foob@r1234\", details_on_error=\"true\"}'
        # spellchecker: enable
        labels: '{alpha=\"one\", beta=\"two\"}'
        tags: '[\"apple\",\"banana\"]'
        min_cpu_platform: Intel Skylake
        automatic_restart: "false"
        preemptible: "true"
        ssh_keys: "admin: ssh-rsa THIS IS NOT A VALID SSH KEY: admin"
        delete_disk_on_destroy: "true"
        disk_type: pd-standard
        disk_size_gb: "50"
        provision_external_public_ip: "false"
        external_subnetwork_tier: STANDARD
        provision_management_public_ip: "true"
        management_subnetwork_tier: STANDARD
        provision_internal_public_ip: "true"
        internal_subnetwork_tier: STANDARD
        allow_phone_home: "false"
        default_gateway: "172.16.0.1"
        use_cloud_init: "true"
        ntp_servers: '[\"169.254.169.254\", \"132.163.96.1\", \"132.163.96.2\"]'
        timezone: America/Los_Angeles
        modules: '{ltm=\"nominal\", asm=\"none\"}'
        dns_servers: '[\"169.254.169.254\", \"9.9.9.9\"]'
        search_domains: '[\"example.com\"]'
        # yamllint disable-line rule:line-length
        install_cloud_libs: '[\"https://github.com/F5Networks/f5-appsvcs-extension/releases/download/v3.25.0/f5-appsvcs-3.25.0-3.noarch.rpm\",\"https://github.com/F5Networks/f5-declarative-onboarding/releases/download/v1.18.0/f5-declarative-onboarding-1.18.0-4.noarch.rpm\",\"https://github.com/F5Networks/f5-cloud-failover-extension/releases/download/v1.7.1/f5-cloud-failover-1.7.1-1.noarch.rpm\"]'
        extramb: "2560"
        as3_payloads: '[]'
        do_payloads: '[]'
    verifier:
      systems:
        - name: inspec-gcp
          backend: gcp
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-cfe-8nic-full-gcp-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-cfe-8nic-full-gcp-<%= report_ts %>.html
        - name: local
          backend: local
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= params[:version] %>-cfe-8nic-full-local-<%= report_ts %>.txt
            - html2:<%= report_dir %>/<%= params[:version] %>-cfe-8nic-full-local-<%= report_ts %>.html
<% end %>

suites:
  - name: bigip
